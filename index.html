<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>kVT AI LIVE SIGNAL Dashboard (Stable Version)</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
  rel="stylesheet"
/>
<style>
  :root {
    --bg: #0f172a;
    --panel: #1e293b;
    --accent: #4ade80;
    --danger: #ef4444;
    --warn: #fbbf24;
    --text: #e2e8f0;
  }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: Poppins, Segoe UI, sans-serif;
    background: var(--bg);
    color: var(--text);
  }
  header {
    background: #020617;
    padding: 1rem 2rem;
    text-align: center;
    user-select: none;
  }
  header h1 {
    color: var(--accent);
    font-size: 1.8rem;
    letter-spacing: 1px;
    margin: 0;
  }
  main {
    padding: 1rem 2rem 2rem;
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    gap: 2rem;
    grid-template-columns: 1fr;
  }
  /* Desktop layout: Chart on left, signals/market on right */
  @media (min-width: 992px) {
    main {
      grid-template-columns: 2fr 1fr;
    }
  }

  /* Main content area (left side) */
  #left-col {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Right side column */
  #right-col {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  #tvChart {
    width: 100%;
    height: 550px;
    border-radius: 12px;
    border: 1px solid #334155;
  }

  #controlsPanel {
    background: var(--panel);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
  }
  #symbolSelect {
    background: #334155;
    color: var(--text);
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
  }
  #balanceInput {
    background: #334155;
    color: var(--text);
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    width: 150px;
    margin-left: auto;
  }
  #positionAdvice {
    color: var(--accent);
    font-size: 0.9rem;
    font-weight: 600;
    user-select: none;
    background-color: var(--bg);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-align: center;
    flex-basis: 100%; /* Take full width on small screens */
  }
   @media(min-width: 768px){
    #positionAdvice {
        flex-basis: auto;
    }
   }

  section {
    background: var(--panel);
    border-radius: 12px;
    padding: 1rem;
  }
  section h2 {
    color: #60a5fa;
    margin: 0 0 1rem 0;
    font-size: 1.2rem;
    user-select: none;
    border-bottom: 1px solid #334155;
    padding-bottom: 0.75rem;
  }

  .signal-card {
    background: var(--bg);
    border: 1px solid #334155;
    border-left: 5px solid var(--warn);
    border-radius: 10px;
    padding: 1rem;
    user-select: none;
  }
  .signal-card p {
    margin: 0.4rem 0;
    font-size: 0.95rem;
  }
  .signal-card strong {
    font-size: 1.1rem;
    color: var(--warn);
  }
  
  .live-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  .live-table th,
  .live-table td {
    padding: 0.6rem 0.75rem;
    text-align: center;
    border-bottom: 1px solid #334155;
  }
  .live-table tr:last-child td {
    border-bottom: none;
  }
  .price-up {
    color: var(--accent);
  }
  .price-down {
    color: var(--danger);
  }

</style>
</head>
<body>
<header><h1>kVT AI LIVE SIGNAL</h1></header>
<main>
  <div id="left-col">
    <div id="tvChart"></div>
    <div id="controlsPanel">
      <select id="symbolSelect"></select>
      <input type="number" id="balanceInput" value="1000" min="10" step="1" />
      <div id="positionAdvice"></div>
    </div>
  </div>

  <div id="right-col">
    <section>
      <h2>Live Signal</h2>
      <div id="signalBox"></div>
    </section>

    <section>
      <h2>All Markets (1s Refresh)</h2>
      <table class="live-table" id="marketTable">
        <thead>
          <tr>
            <th>Pair</th>
            <th>Price</th>
            <th>24h %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>
</main>

<script src="https://s3.tradingview.com/tv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
<script>
  // =================================================================
  // CONFIGURATION & DOM ELEMENTS
  // =================================================================
  const symbols = [
    { code: "BINANCE:BTCUSDT", label: "BTC/USDT" }, { code: "BINANCE:ETHUSDT", label: "ETH/USDT" },
    { code: "BINANCE:BNBUSDT", label: "BNB/USDT" }, { code: "BINANCE:SOLUSDT", label: "SOL/USDT" },
    { code: "BINANCE:XRPUSDT", label: "XRP/USDT" }, { code: "BINANCE:ADAUSDT", label: "ADA/USDT" },
    { code: "BINANCE:DOGEUSDT", label: "DOGE/USDT" }, { code: "NASDAQ:TSLA", label: "TSLA" },
    { code: "OANDA:XAUUSD", label: "GOLD" }, { code: "TVC:USOIL", label: "US OIL" },
  ];

  const symbolSelect = document.getElementById("symbolSelect");
  const balanceInput = document.getElementById("balanceInput");
  const adviceBox = document.getElementById("positionAdvice");
  const signalBox = document.getElementById("signalBox");
  const tableBody = document.querySelector("#marketTable tbody");
  
  let tvWidget;
  let currentSignal = null; // Holds the one and only active signal
  let lastPrices = {}; // Caches latest prices for all symbols

  // =================================================================
  // INITIALIZATION
  // =================================================================
  function initializeApp() {
    // 1. Populate the dropdown menu with symbols
    symbols.forEach((s) => {
      const opt = document.createElement("option");
      opt.value = s.code;
      opt.textContent = s.label;
      symbolSelect.appendChild(opt);
    });

    // 2. Load the initial chart
    loadChart(symbolSelect.value);
    
    // 3. Generate the first signal
    generateSignal(symbolSelect.options[0].text);
    
    // 4. Start live market data refresh
    refreshMarket();
    setInterval(refreshMarket, 1000);

    // 5. Add event listeners
    symbolSelect.addEventListener("change", handleSymbolChange);
    balanceInput.addEventListener("input", () => updatePositionAdvice(currentSignal));
  }

  // =================================================================
  // CORE FUNCTIONS
  // =================================================================
  
  // This is the main trigger when user selects a new pair
  function handleSymbolChange(e) {
    const selectedSymbolCode = e.target.value;
    const selectedSymbolLabel = e.target.options[e.target.selectedIndex].text;
    
    loadChart(selectedSymbolCode);
    generateSignal(selectedSymbolLabel);
  }

  // Loads or updates the TradingView chart widget
  function loadChart(symbolCode) {
    if (tvWidget) {
      tvWidget.setSymbol(symbolCode, "5", () => {});
    } else {
      tvWidget = new TradingView.widget({
        container_id: "tvChart",
        symbol: symbolCode,
        interval: "5",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        allow_symbol_change: false,
        autosize: true,
      });
    }
  }

  // Creates a new random signal for the selected pair
  function generateSignal(pairLabel) {
    const dir = Math.random() > 0.5 ? "BUY" : "SELL";
    // Use a realistic price base if available, otherwise a random one
    const basePrice = (lastPrices[pairLabel]?.price) || (100 + Math.random() * 50000);
    const entry = parseFloat(basePrice.toFixed(4));
    
    // Calculate SL and TPs based on entry price and direction
    const sl = parseFloat((dir === "BUY" ? entry * 0.99 : entry * 1.01).toFixed(4));
    const tp1 = parseFloat((dir === "BUY" ? entry * 1.005 : entry * 0.995).toFixed(4));
    const tp2 = parseFloat((dir === "BUY" ? entry * 1.012 : entry * 0.988).toFixed(4));
    
    const winChance = Math.floor(65 + Math.random() * 25);
    
    currentSignal = {
      pair: pairLabel, type: dir, entry, sl, tp1, tp2, winChance
    };

    renderSignal(currentSignal);
    updatePositionAdvice(currentSignal);
  }

  // Displays the current signal in the UI
  function renderSignal(s) {
    signalBox.innerHTML = `
      <div class="signal-card">
        <p>Pair: <strong>${s.pair}</strong></p>
        <p>Direction: <b style="color:${s.type === 'BUY' ? 'var(--accent)' : 'var(--danger)'}">${s.type}</b></p>
        <p>Entry Price: ${s.entry}</p>
        <p>Stop Loss: ${s.sl}</p>
        <p>Take Profit 1: ${s.tp1}</p>
        <p>Take Profit 2: ${s.tp2}</p>
        <p>Win Chance: ${s.winChance}%</p>
      </div>
    `;
  }
  
  // Calculates and displays the position size advice
  function updatePositionAdvice(s) {
    if (!s) return;
    const balance = parseFloat(balanceInput.value) || 0;
    const riskPercent = 2.0; // Fixed 2% risk
    
    const riskUsd = (balance * riskPercent) / 100;
    const priceDifference = Math.abs(s.entry - s.sl);
    
    if (balance === 0 || priceDifference === 0) {
      adviceBox.textContent = `Set balance to calculate position size.`;
      return;
    }
    
    const quantity = riskUsd / priceDifference;
    adviceBox.textContent = `Risking $${riskUsd.toFixed(2)} (2%) â–¶ Position Qty: ${quantity.toFixed(4)}`;
  }

  // Fetches live market data and updates the table
  async function refreshMarket() {
    try {
      const response = await axios.get("https://api.binance.com/api/v3/ticker/24hr");
      const marketData = response.data;
      tableBody.innerHTML = ""; // Clear previous data
      
      symbols.forEach((sym) => {
        let price = 0, change = 0;
        
        if (sym.code.startsWith("BINANCE:")) {
          const data = marketData.find(d => d.symbol === sym.code.split(':')[1]);
          if (data) {
            price = parseFloat(data.lastPrice);
            change = parseFloat(data.priceChangePercent);
          }
        } else {
          // Mock data for non-Binance symbols
          price = (lastPrices[sym.label]?.price || 100 + Math.random() * 500) * (1 + (Math.random() - 0.5) * 0.005);
          change = (Math.random() - 0.5) * 5;
        }

        // Cache the price for signal generation
        lastPrices[sym.label] = { price };
        
        const priceClass = change >= 0 ? "price-up" : "price-down";
        tableBody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${sym.label}</td>
            <td class="${priceClass}">${price.toFixed(4)}</td>
            <td class="${priceClass}">${change.toFixed(2)}%</td>
          </tr>
        `);
      });
    } catch (error) {
      console.error("Error fetching market data:", error);
      tableBody.innerHTML = `<tr><td colspan="3" style="color:var(--danger)">Could not load market data.</td></tr>`;
    }
  }

  // =================================================================
  // START THE APPLICATION
  // =================================================================
  initializeApp();

</script>
</body>
</html>
